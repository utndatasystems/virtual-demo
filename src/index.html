<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>virtual</title>

  <!-- CodeMirror CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/theme/neo.min.css"
  />

  <!-- Google Fonts -->
  <!-- <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"> -->
  <link href='https://fonts.googleapis.com/css?family=Inter' rel='stylesheet'>

  <!-- Include xterm.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm/css/xterm.css" />

  <!-- Include xterm.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/xterm/lib/xterm.js"></script>

  <link rel="stylesheet" href="assets/index.css">
</head>
<body>
  <p style="font-size: 30px;">What table should I virtualize for you today?</p>
  
  <div id="main-container">
    <!-- Drag and Drop Area -->
    <div id="drag-drop-area">
      <span>
        <img src="assets/csv.svg">
        <img src="assets/parquet.png" width="60" height="60" style="margin-bottom: -0.75em;">
      </span>
    </div>

    <!-- Editor Container -->
    <div id="editor-container">
      <textarea id="query-box">
import pandas as pd

# Specify your `df`.
df = pd.DataFrame({
'A': [],
'B': []
})
      </textarea>
    </div>
  </div>
  <div id="terminal-container" class="collapsed"> <!-- Ensure it's collapsed initially -->
    <div id="terminal-header">
      <span>Terminal</span>
      <button id="toggle-terminal">⏵</button> <!-- Change default icon -->
    </div>
    <div id="terminal-output"></div>
  </div>  
  

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>

  <script>
    // Drag and Drop Logic
    const dropArea = document.getElementById('drag-drop-area');
    dropArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropArea.classList.add('hover');
    });
    dropArea.addEventListener('dragleave', () => {
      dropArea.classList.remove('hover');
    });

    // Loader element
    // const loader = document.createElement('div');
    // loader.classList.add('loader');  // You can style this in CSS
    // loader.innerHTML = 'Preparing the dashboard...';

    // Add event listener for the drop event
    dropArea.addEventListener('drop', async (e) => {
      e.preventDefault();
      dropArea.classList.remove('hover');
      
      const file = e.dataTransfer.files[0];

      // Set the file path in local storage
      localStorage.setItem('csvPath', file.path);

      // Show the loader
      // document.body.appendChild(loader);

      // Send query to the main process to run the Python script
      await window.electronAPI.virtualize(file.path, 'file');

      // Hide the loader and redirect to dashboard.html
      // document.body.removeChild(loader);
      window.location.href = 'dashboard.html';
    });

    // CodeMirror Settings
    const editorSettings = {
      lineNumbers: true,
      mode: "python",
      theme: "neo",
      extraKeys: {
        "Ctrl-Space": "autocomplete",
        "Enter": async (cm) => {
          const code = cm.getValue();
          // alert("Running the following code:\n" + code);

          // Show the loader
          // document.body.appendChild(loader);

          // Send query to the main process to run the Python script
          await window.electronAPI.virtualize(code, 'code');

          localStorage.setItem('csvPath', 'tmp.csv')

          // Hide the loader and redirect to dashboard.html
          // document.body.removeChild(loader);
          window.location.href = 'dashboard.html';
        },
      },
      lineWrapping: true,
      matchBrackets: true,
    };

    const editor = CodeMirror.fromTextArea(
      document.getElementById("query-box"),
      editorSettings
    );

// Ensure the toggle button starts with the correct icon
const terminalContainer = document.getElementById('terminal-container');
const toggleButton = document.getElementById('toggle-terminal');
const terminalOutput = document.getElementById('terminal-output');

toggleButton.addEventListener('click', () => {
  terminalContainer.classList.toggle('collapsed');
  toggleButton.textContent = terminalContainer.classList.contains('collapsed') ? '⏵' : '⏷';
});

// Function to check if the user is at the bottom of the terminal
function isScrolledToBottom() {
  return terminalOutput.scrollHeight - terminalOutput.clientHeight <= terminalOutput.scrollTop + 10;
}

// Function to append log messages and uncollapse terminal if needed
function appendToTerminal(message) {
  // Uncollapse the terminal if it's collapsed
  if (terminalContainer.classList.contains('collapsed')) {
    terminalContainer.classList.remove('collapsed');
    toggleButton.textContent = '⏷';
  }

  const wasScrolledToBottom = isScrolledToBottom();

  const newMessage = document.createElement('div');
  // if (!message.endsWith('\n')) {
  //   message += '\n';
  // }
  newMessage.textContent = message;
  terminalOutput.appendChild(newMessage);

  // Scroll to bottom only if the user was already at the bottom
  if (wasScrolledToBottom) {
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }
}

// Listen for log events from the main process
window.electronAPI.receive('virtualize-log', (message) => {
  appendToTerminal(message);
});

// Function to hide terminal when a plot is shown
function hideTerminalForPlot() {
  terminalContainer.classList.add('collapsed');
  toggleButton.textContent = '⏵';
}

// Listen for the event when a plot is displayed
window.electronAPI.receive('show-plot', () => {
  hideTerminalForPlot();
});


  </script>
</body>
</html>

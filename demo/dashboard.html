<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preview CSV</title>

  <!-- Add these inside the <head> tag or before </body> -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css"> -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/theme/neo.min.css"> -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"> -->


<!-- CodeMirror CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/theme/neo.css"> <!-- or your chosen theme -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/theme/material.css"> or your chosen theme -->



  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/codemirror.min.js"></script>


  <!-- CodeMirror Mode for SQL -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/sql/sql.min.js"></script> -->


  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.3/mode/sql/sql.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/addon/hint/sql-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/addon/lint/lint.min.js"></script>
     <script type="text/javascript"
     src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
   </script>

  <link rel="stylesheet" href="assets/dashboard.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <script src="util.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <div class="very-special-header">
        <h1><a href="index.html" style="color: inherit; text-decoration: none;"><code>Virtual</code></a>: Dashboard</h1>
        <!-- <div class="button-group1"> -->
          <!-- <button class="btn-option active" data-option="sample"><code>sample</code></button> -->
          <!-- <button class="btn-option" data-option="lineitem"><code>lineitem (TPC-H)</code></button> -->
        <!-- </div> -->
      </div>
    </header>    
    <!-- Top Section -->
    <div class="top-section">
      <!-- CSV Preview -->
      <div class="left-panel">
        <div class="header">
          <h2>üîç Table Preview</h2>
          <code class="switch-text2">Virtual view</code>
          <label class="switch">
            <input type="checkbox" id="toggle-virtual">
            <span class="slider"></span>
          </label>
        </div>
        <div class="csv-container">
          <table id="csvTable"></table>
        </div>
      </div>
      <!-- Functions -->
      <div class="right-panel">
        <div id="controls">
          <div class="special-header">
            <h2>üìà Functions</h2>
          </div>
          <div id="formulas"></div> <!-- This is where the formulas will be displayed -->
          <h2>‚öñÔ∏è File Size</h2>
          <canvas id="barChart"></canvas> <!-- This is where the formulas will be displayed -->
        </div>
      </div>
    </div>
    <!-- Bottom Section -->
    <div class="bottom-section">
      <!-- SQL Query Interface -->
      <div class="left-panel">
        <div id="sql-query-interface" class="query-interface">
          <div class="header">
            <h2>üìä SQL Query Interface</h2>
            <div class="button-group">
              <button class="btn-option" data-option="parquet"><code>parquet</code></button>
              <button class="btn-option active" data-option="virtual"><code>virtual</code></button>
            </div>
            <div id="virtual-switch" style="display: block;">
              <code class="switch-text">Show rewrite</code>
              <label class="switch" >
                <input type="checkbox" id="toggle-query">
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div class="query-container">
            <div id="query-view1">
              <textarea id="query-box" placeholder="Write your SQL query here..."></textarea>
            </div>
            <div id="query-view2" style="display: none;">
              <textarea id="rewritten-query-box" placeholder="Rewritten SQL query..." readonly></textarea>
            </div>
          </div>
          <button id="run-query" class="run-button" type="submit">
            <i class="fas fa-play"></i>
          </button>
          <!-- <button id="run-query" class="btn"><i class="fas fa-play"></i></button>   -->
        </div>
      </div>
      
      <!-- Query Output -->
      <div class="right-panel">
        <div class="special-header">
          <h2>üìù Query Output</h2>
        </div>
        <!-- <div id="output-console" class="output-console"> -->          
          <pre id="query-output"></pre>
        <!-- </div> -->
      </div>
    </div>
  </div>  
    
  <script type="module">
    // Retrieve CSV path.
    const csvPath = localStorage.getItem('csvPath');
    // const csvPath = '/Users/mihail/Documents/utn/compression/data-gov/Broome-County-Annual-Employee-Earnings:-Beginning-2009.csv'
      // '/Users/mihail/Downloads/smcrds_csv/smcrds_utf8.csv'

    // Read the sizes for this file.
    const sizes = await fetch('sizes.json').then(res => res.json());
    const functions = await fetch('layout.json').then(res => res.json());

    console.log(functions);

    // The editor settings.
    const editor_settings = {
      lineNumbers: true,
      mode: "text/x-sql",
      theme: "neo",   // Default theme (dark mode)
      extraKeys: {
        "Ctrl-Space": "autocomplete",
      },
      lineWrapping: true,
      matchBrackets: true,
      lint: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-lint-markers"]
    };

    // Instantiate the editors.
    const editor = CodeMirror.fromTextArea(document.getElementById("query-box"), editor_settings);
    const rewritten_editor = CodeMirror.fromTextArea(document.getElementById("rewritten-query-box"), editor_settings);

    // Set readonly for the rewritten query.
    rewritten_editor.setOption("readOnly", "nocursor");

    // And refresh. This fixes the issue with line numbers.
    rewritten_editor.refresh();

    // Event for showing the rewrite.
    document.getElementById("toggle-query").addEventListener("change", async function (e) {
      const view1 = document.getElementById("query-view1")
      const view2 = document.getElementById("query-view2");      
      const rewrittenQueryBox = document.getElementById("rewritten-query-box");
      
      if (e.target.checked) {
        view2.style.display = "block";

        // Fetch the query.
        const query = editor.getValue();

        // Get the active option from the button group
        const active_format = document.querySelector('.button-group').querySelector('.btn-option.active').getAttribute('data-option');

        // Get the rewritten query.
        const rewritten_query = await window.electronAPI.rewriteQuery(query, csvPath, active_format);

        // Set the query.
        rewritten_editor.setValue(rewritten_query['query']);
      } else {
        view2.style.display = "none";
      }
    });

    // Event for showing the virtual file.
    document.getElementById("toggle-virtual").addEventListener("change", async (e) => {
      console.log('sinide hre')
      if (e.target.checked) {
        await loadCsv('file_virtual.parquet');
      } else {
        await loadCsv(csvPath)
      }
    });

    // Execute query on button click
    document.getElementById("run-query").addEventListener("click", async function() {
      document.getElementById("query-output").innerText = "Executing..";

      // Fetch the query.
      const query = editor.getValue();

      // Get the active option from the button group
      const active_format = document.querySelector('.button-group').querySelector('.btn-option.active').getAttribute('data-option');

      // Send query to the main process to run the Python script
      const result = await window.electronAPI.runQuery(query, csvPath, active_format);

      console.log(result);

      const outputArea = document.getElementById("query-output");

      // Clear the output area.
      outputArea.innerHTML = "";

      const timer = document.createElement('span');

      // Also put the actual query time, if we deal with `virtual`.
      if (active_format === 'virtual') {
        timer.innerHTML = `Rewrite time: ${((result.query_time - result.metal_query_time) / 1e6).toFixed(2)} ms`
        timer.innerHTML += `\nExecution time: ${(result.metal_query_time / 1e6).toFixed(2)} ms`
      } else {
        timer.innerHTML = `Query time: ${(result.query_time / 1e6).toFixed(2)} ms`
      }

      outputArea.appendChild(timer);
      outputArea.appendChild(document.createElement('br'));
      outputArea.appendChild(document.createElement('br'));

      // Ensure result.data is an array
      let dataArray = typeof result.data === "string" ? JSON.parse(result.data) : result.data;

      if (Array.isArray(dataArray) && result.data.length > 0) {
        // Clear existing results

        // Create a table
        const table = document.createElement("table");
        table.style.borderCollapse = "collapse";
        table.style.width = "100%";

        // Create table headers
        const headerRow = document.createElement("tr");
        result.header.forEach((header) => {
          const th = document.createElement("th");
          th.style.border = "1px solid #ddd";
          th.style.padding = "8px";
          th.style.textAlign = "left";
          th.innerText = header;
          headerRow.appendChild(th);
        });

        console.log(headerRow);

        table.appendChild(headerRow);

        // Create table rows
        dataArray.forEach((row) => {
          const tableRow = document.createElement("tr");
          row.forEach((cell) => {  // Use `row` directly instead of `Object.values(row)`
            const td = document.createElement("td");
            td.style.border = "1px solid #ddd";
            td.style.padding = "8px";
            td.innerText = cell;
            tableRow.appendChild(td);
          });
          table.appendChild(tableRow);
        });

        // Append table to the output area
        outputArea.appendChild(table);
      } else {
        document.getElementById("query-output").innerText += "\nNo results found.";
      }
    });
  
    // Function to generate and display the formulas
    function generateFormulas(functions) {
      const formulasContainer = document.getElementById('formulas');
      
      let myround = (x) => {
        let int_repr = Math.round(x);
        if (Math.abs(x - int_repr) < 1e-6) {
          return int_repr;
        } else {
          return x.toFixed(4);
        }
      }

      functions.greedy.chosen.forEach(item => {
        const model_type = item['model-type'];
        const terms = item[model_type].coeffs;

        // Create the formula in LaTeX format
        const formula = terms.map(term => {
          const rounded_coef = myround(term.coeff);
          const col_name = term['col-name'];
          if (rounded_coef === 1)
            return `${col_name}`;
          return `${rounded_coef} * ${col_name}`;
        }).join(' + ');

        console.log(formula);

        // Wrap the formula in LaTeX math syntax
        const latexFormula = `<code>${item['target-name']} = ${formula}</code>`;

        // Create a button element to hold the formula and append it to the page
        const formulaButton = document.createElement('button');
        formulaButton.innerHTML = `${latexFormula}`; // MathJax will render this LaTeX code
        formulaButton.classList.add('formula-button');

        // Add click event listener to populate the SQL query textarea and editor
        formulaButton.addEventListener('click', () => {
          const queryBox = document.getElementById('query-box');

          // Dynamically generate the AVG query
          const avgQuery = `min("${item['target-name']}")`;

          // Log the computed values
          console.log('Formula:', formula);
          console.log('Min query:', avgQuery);

          // Update the editor with the AVG query
          if (typeof editor !== 'undefined' && editor.setValue) {
            editor.setValue(`select ${avgQuery}\nfrom table;`);
          }

          // Update the query box for reference
          queryBox.value = `${item.target_name} = ${formula}`;
        });

        formulasContainer.appendChild(formulaButton);
      });
    }

    document.getElementById("toggle-query").addEventListener("change", function() {
      const queryBox = document.getElementById("query-box");
      
      // Optimized Query - Replace with your actual optimized query
      const optimizedQuery = "SELECT * FROM optimized_table WHERE condition = true;"; 
      
      // Check if the switch is turned on or off
      if (this.checked) {
        // When the switch is on, display the optimized query
        queryBox.value = optimizedQuery;
      } else {
        // When the switch is off, clear the optimized query or return to original state
        queryBox.value = "";
      }
    });

    // // Display column size information from sizes.json
    // function displayColumnSizes() {
    //   const sizesContainer = document.getElementById('sizesContainer'); // Assuming there's a div with id 'sizesContainer'
    //   sizesContainer.innerHTML = ''; // Clear any existing content
  
    //   for (const [column, size] of Object.entries(sizes)) {
    //     const div = document.createElement('div');
    //     div.textContent = `Column: ${column}, Size: ${size}`;
    //     sizesContainer.appendChild(div);
    //   }
    // }


    // // Additional styles for the buttons (optional)
    // document.querySelectorAll('.formula-button').forEach(button => {
    //   button.style.cursor = 'pointer';
    // });

    // function generateSizes() {
    //   const sizesContainer = document.getElementById('sizes');
    //   for (const key in sizes) {
    //     const size_span = document.createElement('span');
    //     size_span.innerHTML = `<code>${key}: ${sizes[key] / 1000000} MB</code>`;
    //     sizesContainer.appendChild(size_span);
    //     // New line after each span
    //     sizesContainer.appendChild(document.createElement('br'));
    //   }
    // }

    // Toggle the option buttons.
    document.querySelector('.button-group').querySelectorAll('.btn-option').forEach(button => {
      button.addEventListener('click', () => {
        // Remove active class from all buttons
        let option = button.getAttribute('data-option');
        console.log(option);

        // Check whcih option the user selected.
        if (option !== 'virtual') {
          const view2 = document.getElementById("query-view2");      
          view2.style.display = 'none';

          // Untoggle.
          document.getElementById('toggle-query').checked = false;

          // Make it disappear.
          document.getElementById('virtual-switch').style.display = 'none';
        } else {
          // Make it reappear.
          document.getElementById('virtual-switch').style.display = 'block';  
        }

        document.querySelector('.button-group').querySelectorAll('.btn-option').forEach(btn => btn.classList.remove('active'));
        
        // Add active class to the clicked button
        button.classList.add('active');
      });
    });
  
    // Initialize the script
    (async function init() {
      await loadCsv(csvPath);
      // displayColumnSizes();
      generateFormulas(functions);
      generateSizes(sizes);
    })();
  </script>  
</body>
</html>
